<html>
<head>
    <meta charset="utf-8">

    <title>OpenWeek 2018 - Développement de plugins pour ICTV</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/css/reveal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/css/theme/blood.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/lib/css/zenburn.css">

    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/' + (window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css');
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <style>
        #plugin-get-content code {
            padding: 0;
        }
    </style>
</head>

<body>
<div class="reveal">
    <div class="slides">
        <section id="titre">
            <h1>OpenWeek 2018</h1>
            <h2>Développement de plugins pour ICTV</h2>
            <a href="https://openweek.github.io/presentations/presentation-ictv/index.html" target="_blank">https://openweek.github.io/presentations/presentation-ictv/index.html</a>
            <br>
            <br>
            <small>Maxime Piraux - <a href="mailto:maxime.piraux@student.uclouvain.be" target="_blank">maxime.piraux@student.uclouvain.be</a></small>
        </section>
        <section id="intro">
            <h2>Qu'est ce que ICTV ?</h2>
            <ul>
                <li>ICTV est un <a href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_de_gestion_de_contenu" target="_blank">système de gestion de contenu</a> pour l'<a href="https://fr.wikipedia.org/wiki/Affichage_dynamique" target="_blank">affichage dynamique</a>.</li>
                <li class="fragment">ICTV vous permet de créer et modifier du contenu qui sera affiché sur un réseau d'écrans.</li>
                <li class="fragment">L'interface d'ICTV est entièrement basée sur le web. Tout depuis la gestion du contenu jusqu'à sa reproduction sur les écrans est effectué dans un navigateur.</li>
                <li class="fragment">ICTV est facilement extensible grâce à un système de plugins simple et puissant.</li>
                <li class="fragment">ICTV est developpé en INGI pour l'UCL: <a href="https://github.com/UCL-INGI/ICTV" target="_blank">https://github.com/UCL-INGI/ICTV</a></li>
            </ul>
        </section>
        <section id="concepts">
            <h2>Trois concepts clés</h2>
            <ul>
                <li><a href="#/plugins">Plugins</a></li>
                <li><a href="#/channels">Channels</a></li>
                <li><a href="#/screens">Screens</a></li>
            </ul>
        </section>
        <section id="plugins">
            <h2>Plugins</h2>
            <p>Tout contenu provient d'un plugin.</p>
            <ul>
                <li class="fragment">Un plugin peut être un programme automatisé.</li>
                <li class="fragment">E.g. un programme qui crée du contenu à partir d'un flux RSS.</li>
                <li class="fragment">Interaction plus large avec les utilisateurs possible à travers l'intégration d'une sous-application web propre au plugin dans ICTV.</li>
                <li class="fragment">La configuration des plugins se fait via l'interface web d'ICTV.</li>
            </ul>
        </section>
        <section id="plugins-2">
            <h2>Plugins</h2>
            <p>Il existe déjà des plugins utiles:</p>
            <ul>
                <li><strong>editor</strong> est un éditeur web permettant de créer des diaporamas.</li>
                <li><strong>embed</strong> permet d'intégrer des pages web dans le système.</li>
                <li><strong>rss</strong> permet d'extraire et de transformer des flux RSS en diaporamas.</li>
                <li><strong>cal</strong> crée des annonces sur base d'événements de calendrier.</li>
                <li><strong>img-grabber</strong> extrait des images de pages web.</li>
                <li><strong>survey</strong> permet d'effectuer des sondages avec des QR codes.</li>
            </ul>
        </section>
        <section id="channels">
            <h2>Channels</h2>
            <ul>
                <li>Elles permettent d'organiser le contenu.</li>
                <li>Chaque channel contient un type d'information thématique.</li>
                <li class="fragment">Les channels peuvent être publiques ou restreintes à certains utilisateurs.</li>
                <li class="fragment">
                    <code>PluginChannel</code>
                    <ul>
                        <li>Chaque channel est une instance, une paramétrisation, d'un plugin.</li>
                    </ul>
                </li>
                <li class="fragment">
                    <code>ChannelBundle</code>
                    <ul>
                        <li>Regroupe des channels ensemble.</li>
                    </ul>
                </li>

            </ul>
        </section>
        <section id="screens">
            <h2>Screens</h2>
            <ul>
                <li>Une sortie affichant du contenu</li>
                <li>Peut être physique, i.e. un écran, ou virtuel, i.e. une page web.</li>
                <li class="fragment">Les écrans diffusent le contenu des channels auxquelles ils sont abonnés.</li>
                <li class="fragment">Les abonnements d'un écran vont déterminer le contenu qui y sera affiché.</li>
            </ul>
        </section>
        <section id="contenu">
            <h2>Contenu</h2>
            <ul>
                <li>Un diaporama de slides utilisant <a href="http://lab.hakim.se/reveal-js/" target="_blank">reveal.js</a></li>
                <li>Utilise les nombreuses possibilités offertes par HTML5 et CSS3.</li>
                <li>Compositions complexes, GIFs, vidéos et images de fond sont possibles.</li>
            </ul>
        </section>
        <section id="technologies">
            <h2>Technologies utilisées</h2>
            <ul>
                <li>
                    Coté client
                    <ul>
                        <li><a href="http://github.com/hakimel/reveal.js" target="_blank">reveal.js</a> pour les diaporamas.</li>
                        <li><a href="https://adminlte.io/preview" target="_blank">AdminLTE</a> pour l'interface utilisateur, basé sur JQuery et Bootstrap.</li>
                    </ul>
                </li>
                <li class="fragment">
                    Coté serveur
                    <ul>
                        <li><a href="https://www.python.org/" target="_blank">Python 3.5+</a></li>
                        <li><a href="http://webpy.org/" target="_blank">web.py</a> comme framework web pour Python.</li>
                    </ul>
                </li>
            </ul>
        </section>
        <section id="intermede">
            <h1>Intermède</h1>
            <h3 class="fragment">Votre mission</h3>
            <p class="fragment">Imaginer un nouveau plugin utile pour ICTV, pas nécessairement lié à l'INGI.</p>
            <p class="fragment">Plus il peut être utilisé dans de nombreuses situations, plus son intérêt est grand.</p>
        </section>
        <section id="idees">
            <h2>Un peu d'inspiration</h2>
            <ul>
                <li class="fragment">Un plugin combiné avec INGInious permettant d'obtenir des statistiques sur les tâches.</li>
                <li class="fragment">Un plugin permettant d'afficher les départs de trains à Louvain-La-Neuve.</li>
                <li class="fragment">Un plugin permettant suivre les évenements d'un repository Github.</li>
            </ul>
        </section>
        <section id="intro-plugin">
            <h1>Plugins dans ICTV</h1>
        </section>
        <section id="ictv-doc">
            <h4 style="text-transform: inherit;">Une seule source d'information: la documentation officielle <a href="http://ictv.rtfd.io" target="_blank">http://ictv.rtfd.io</a></h4>
            <iframe class="stretch" src="https://ictv.readthedocs.io/en/latest/"></iframe>
        </section>
        <section id="plugin-schema">
            <h2>Execution</h2>
            <svg data-src="schema.svg" style="background: rgba(255, 255, 255, 0.66); transform: scale(1.5); margin-top: 2em;">
        </section>
        <section id="plugin-slide-capsule">
            <h2>Slides & capsules</h2>
            <pre><code data-trim style="max-height: none;">
                class PluginSlide(metaclass=ABCMeta):
                    @abstractmethod
                    def get_duration(self):
                        pass

                    @abstractmethod
                    def get_content(self):
                        pass

                    @abstractmethod
                    def get_template(self):
                        pass
            </code><code class="fragment" data-trim>
                class PluginCapsule(metaclass=ABCMeta):
                    @abstractmethod
                    def get_slides(self):
                        pass

                    @abstractmethod
                    def get_theme(self):
                        pass
            </code></pre>
        </section>
        <section id="plugin-contenu-slide">
            <h2>Contenu d'une slide</h2>
            <pre><code data-trim>
                {
                    '[field-type]-[field-number]': {'[input-type]': '[field-data]'},
                    ...
                }
            </code></pre>
            <div style="display: flex; height: 50%;" >
                <div style="flex: 1;">
                    <h5 style="text-transform: none">field-type</h5>
                    <code>
                    <ul>
                        <li>title</li>
                        <li>subtitle</li>
                        <li>text</li>
                        <li>logo</li>
                        <li>image</li>
                        <li>background</li>
                    </ul>
                    </code>
                </div>
                <div style="flex: 1;">
                    <h5 style="text-transform: none">input-type</h5>
                    <ul>
                        <li><code>title</code>, <code>subtitle</code>, <code>text</code>: <ul><li><code>text</code></li></ul></li>
                        <li><code>logo</code>, <code>image</code>:
                            <code><ul>
                                <li>src</li>
                                <li>qrcode</li>
                            </ul></code>
                        </li>
                        <li><code>background</code>:
                            <code><ul>
                                <li>src</li>
                                <li>size</li>
                                <li>qrcode</li>
                            </ul></code>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        <section id="plugin-renderer">
            <h2>Renderer</h2>
            <p>Transforme la représentation abstraite d'une slide en HTML pour reveal.js via un template.</p>
            <div style="display: flex;">
                <pre class="fragment" style="flex: 2;"><code data-trim style="max-height: none;">
                    html
                    $def with (slide, theme)
                    <section>
                        <div class="logo logo-ucl">
                            $:logo(content=slide, number=1)
                        </div>
                        <div class="logo logo-fac">
                            $:logo(content=slide, number=2)
                        </div>
                        <div class="content">
                            $:title(content=slide, number=1)
                            $:subtitle(content=slide, number=1)
                            <table>
                                <tr>
                                    <td style="width:34%">
                                        $:img(content=slide, number=1)
                                    </td>
                                    <td style="width:66%; vertical-align:middle">
                                        $:text(content=slide, number=1)
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </section>
                </code></pre>
                <pre style="flex: 1;"><code data-trim style="max-height: none;">
                    {
                        'title-1': {'text': "Awesome title"},
                        'subtitle-1': {'text': "Subtile subtitle"},
                        'text-1': {'text': "Very long textual text here"},
                        'image-1': {'src': "img/michelfra.gif"},
                        'logo-1': {'src': "ingi.gif"},
                        'logo-2': {'src': "ucl.gif"}
                    }
                </code></pre>
            </div>
        </section>
        <section id="plugin-anatomie">
            <h2>Anatomie</h2>
            <pre><code data-trim>
                ictv
                └── plugins
                    └── img-grabber
                        ├── __init__.py
                        ├── config.yaml
                        └── img-grabber.py
            </code></pre>
            <ul>
                <li><code>config.yaml</code> définit la configuration nécessaire a une instance du plugin.</li>
                <li><code>img-grabber.py</code> contient une fonction <code>get_content()</code>.</li>
                <li><code>__init__.py</code> permet a Python de considérer ce dossier comme un module.</li>
            </ul>
        </section>
        <section id="plugin-config">
            <h2>Fichier de configuration</h2>
            <div style="display: flex;">
            <pre style="flex: 1;"><code data-trim style="max-height: none;">
                plugin:
                  webapp: no
                  static: no
                  description: |
                    This plugin embeds an image and a text
                    as legend in a simple way.
                    It uses CSS selector to specify which content
                    to grab from the specified page.
                  dependencies:
                    - pyquery
                channels_params:
                  url:
                    name: 'URL of the page'
                    placeholder: 'Url format'
                    type: string
                    default: 'http://apod.nasa.gov/apod/astropix.html'
                  image_selector:
                    name: 'Image CSS selector'
                    placeholder: 'CSS selector'
                    type: string
                    default: 'img'
                  src_attr:
                    name: 'Attribute holding the image source url'
                    placeholder: 'HTML attribute'
                    type: string
                    default: 'src'
            </code></pre>
            <pre class="fragment" style="flex: 1;"><code style="max-height: none;">
  text_selector:
    name: 'Text CSS selector'
    placeholder: 'CSS selector'
    type: string
    default: 'center>b'
  alternative_text:
    name: 'Alternative text if a text cannot be found with the selector above'
    placeholder: 'Plain text'
    type: string
    default: ''
  duration:
    name: 'Capsule duration in seconds'
    placeholder: 'Capsule duration in seconds'
    type: int
    default: 10
    min: 1
  qrcode:
    name: 'Embed the url of the page as a QR code'
    type: bool
    default: no
            </code></pre>
            </div>
        </section>
        <section id="plugin-slide">
            <h2>Slide</h2>
            <pre><code data-trim style="max-height: none;">
                class ImgGrabberSlide(PluginSlide):
                    def __init__(self, img_src, text, duration, qrcode):
                        self._duration = duration
                        self._content = {'background-1': {'src': img_src, 'size': 'contain'},
                                         'text-1': {'text': text}}
                        if qrcode:
                            self._content['image-1'] = {'qrcode': qrcode}

                    def get_duration(self):
                        return self._duration

                    def get_content(self):
                        return self._content

                    def get_template(self):
                        return 'template-background-text-qr'
            </code></pre>
        </section>
        <section id="plugin-capsule">
            <h2>Capsule</h2>
            <pre><code data-trim style="max-height: none;">
                class ImgGrabberCapsule(PluginCapsule):
                    def __init__(self, img_src, text, duration, qrcode=None):
                        self._slides = [ImgGrabberSlide(img_src, text, duration, qrcode)]

                    def get_slides(self):
                        return self._slides

                    def get_theme(self):
                        return None
            </code></pre>
        </section>
        <section id="plugin-get-content">
            <h2>get_content</h2>
            <pre style="width: 95%;"><code data-trim style="max-height: none;">
                def get_content(channel_id):
                    channel = PluginChannel.get(channel_id)</code><code class="fragment" style="max-height: none;">
    logger_extra = {'channel_name': channel.name, 'channel_id': channel.id}
    logger = get_logger('img-grabber', channel)</code><code class="fragment" style="max-height: none;">
    url = channel.get_config_param('url')
    image_selector = channel.get_config_param('image_selector')
    attr = channel.get_config_param('src_attr')
    qrcode = channel.get_config_param('qrcode')

    if not url or not image_selector or not attr:
        logger.warning('Some of the required parameters are empty', extra=logger_extra)
        return []</code><code class="fragment" style="max-height: none;">
    try:
        doc = PyQuery(url=url)
    except Exception as e:
        raise MisconfiguredParameters('url', url, 'The following error was encountered: %s.' % str(e))</code><code class="fragment" style="max-height: none;">
    img = doc(image_selector).eq(0).attr(attr)
    if not img:
        message = 'Could not find img with CSS selector %s and attribute %s' % (image_selector, attr)
        raise MisconfiguredParameters('image_selector', image_selector, message)
                  .add_faulty_parameter('src_attr', attr, message)
    if img[:4] != 'http' and img[:4] != 'ftp:':
        img = '{uri.scheme}://{uri.netloc}/'.format(uri=urlparse(url)) + img</code><code class="fragment" style="max-height: none;">
    duration = channel.get_config_param('duration') * 1000
    text = doc(channel.get_config_param('text_selector')).eq(0).text()
    alternative_text = channel.get_config_param('alternative_text')
    return [ImgGrabberCapsule(img, text if text else alternative_text, duration,
                              qrcode=url if qrcode else None)]
            </code></pre>
        </section>
        <section id="the-end">
            <h1>Et voila</h1>
            <h3 class="fragment">Pef</h3>
        </section>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/lib/js/head.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/js/reveal.js"></script>

<script>
    function replaceAttributes(new_, old) {
        for (let i=0; i<old.attributes.length; i++) {
            let attr = old.attributes[i]
            new_.setAttribute(attr.name, attr.value)
        }
    }

    /** embed SVGs via data-src
    * e.g. <svg data-src="images/test.svg"></svg>.
    * Useful for styling and using class="fragment" in SVG code
    */
    function loadDataSrcSVG() {
        let svgsToLoad = [ ...document.querySelectorAll('svg[data-src]') ]

        let loadSVGs = svgsToLoad.map(svg => fetch(svg.getAttribute('data-src'))
        .then(response => response.text())
        .then(svgCode => {
            let svgDoc = new DOMParser().parseFromString(svgCode, 'image/svg+xml')
            let newSVG = svgDoc.documentElement
            replaceAttributes(newSVG, svg)
            svg.parentNode.replaceChild(newSVG, svg)
        })
        .catch(error => {
            if (!(error instanceof TypeError))
            throw error
            let img = document.createElement('img')
            img.setAttribute('src', svg.getAttribute('data-src'))
            replaceAttributes(img, svg)
            svg.parentNode.replaceChild(img, svg)
        }))

        Promise.all(loadSVGs).then(val => {
            for (let svg of document.querySelectorAll('svg.stretch:not([preserveAspectRatio])')) {
                if (!svg.hasAttribute('viewBox')) {
                    let w = svg.getAttribute('width')
                    let h = svg.getAttribute('height')
                    svg.setAttribute('viewBox', `0 0 ${w} ${h}`)
                }
                svg.setAttribute('preserveAspectRatio', 'xMidYMid meet')
            }
        })
    }

    loadDataSrcSVG();

    var cdn = 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/';
    Reveal.initialize({
        width: 1440,
        height: 1080,
        controls: true,
        progress: true,
        history: true,
        center: true,
        slideNumber: true,
        transition: 'slide',
        dependencies: [
            {
                src: cdn + 'plugin/highlight/highlight.js', async: true, callback: function () {
                    hljs.configure({
                        languages: ['python', 'html', 'yaml']
                    });
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>

</body>
</html>
